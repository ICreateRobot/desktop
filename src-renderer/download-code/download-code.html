<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>固件烧录</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f5f5f5;
        }

        .container {
            width: 320px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h2 {
            margin-bottom: 20px;
            color: #333;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 10px;
            background: #ff4c4c;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.3s;
        }

        button:hover {
            background: #e04343;
        }

        .qr-container {
            margin-top: 20px;
            display: none;
        }

        .qr-container img {
            width: 150px;
            height: 150px;
            border: 4px solid #ff4c4c;
            padding: 8px;
            background: white;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">

        <select id="portSelector">
            <option disabled selected>请选择串口</option>
        </select>
        <button id="common">ICRobot普通固件</button>
        <button id="xiaoZhi">小智AI固件</button>
        <button id="microbit">烧录Microbit基础固件</button>
        <h1 id="title">请先选择设备</h1>
        <!-- <h2>Wi-Fi 二维码生成</h2>
        <input type="text" placeholder="请输入热点名称" id="name">
        <input type="password" placeholder="请输入热点密码" id="password">
        <button id="submit">生成二维码</button>

        <div class="qr-container" id="qrContainer">
            <p>请扫描二维码连接 Wi-Fi</p>
            <img id="info" src="" alt="Wi-Fi 二维码">
        </div> -->
    </div>

    <script>

        // // 加载串口列表
        // window.addEventListener('DOMContentLoaded', () => {
        //     const selector = document.getElementById('portSelector');
        //     const ports = electronAPI.getPorts();
        //     ports.forEach(port => {
        //         const option = document.createElement('option');
        //         option.value = port;
        //         option.textContent = port;
        //         selector.appendChild(option);
        //     });
        // });

        function updatePorts() {
            const selector = document.getElementById('portSelector');
            const selectedPort = selector.value;

            // 获取串口列表
            let ports=electronAPI.getPorts()
             // 清空现有选项
            selector.innerHTML = '<option disabled>请选择串口</option>';

            let found = false;
            ports.forEach(port => {
                const option = document.createElement('option');
                option.value = port;
                option.textContent = port;
                if (port === selectedPort) {
                    option.selected = true;
                    found = true;
                }
                selector.appendChild(option);
            });

            // 如果之前选择的串口不在当前列表中，选回默认
            if (!found) {
                selector.selectedIndex = 0;
            }
        }

        // 初始加载一次
        window.addEventListener('DOMContentLoaded', () => {
            updatePorts();
            let extension =electronAPI.getExtension()
            if(extension =='2'){
                document.getElementById('title').style.display='none'
                document.getElementById('common').style.display='block';
                document.getElementById('xiaoZhi').style.display='block'
                document.getElementById('portSelector').style.display='block'
                document.getElementById('microbit').style.display='none';
            }else if(extension =='3'){
                document.getElementById('title').style.display='none'
                document.getElementById('microbit').style.display='block';
                document.getElementById('common').style.display='none';
                document.getElementById('xiaoZhi').style.display='none'
                document.getElementById('portSelector').style.display='none'
            }else{
                document.getElementById('title').style.display='block'
                document.getElementById('microbit').style.display='none';
                document.getElementById('common').style.display='none';
                document.getElementById('xiaoZhi').style.display='none'
                document.getElementById('portSelector').style.display='none'
            }
            setInterval(updatePorts, 2000); // 每2秒更新一次
        });

         function showToast(message, duration = 3000) {
            // 如果 toast 容器不存在，则创建一个
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                Object.assign(container.style, {
                    position: 'fixed',
                    top: '20px',
                    right: '20px',
                    zIndex: 9999,
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '10px'
                });
                document.body.appendChild(container);
            }
        
            // 创建 toast 元素
            const toast = document.createElement('div');
            toast.textContent = message;
        
            // 样式设置
            Object.assign(toast.style, {
                background: '#333',
                color: '#fff',
                padding: '10px 20px',
                borderRadius: '8px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.2)',
                opacity: '0',
                transform: 'translateY(-20px)',
                transition: 'opacity 0.3s ease, transform 0.3s ease',
                maxWidth: '300px'
            });
        
            // 添加 toast 到容器
            container.appendChild(toast);
        
            // 强制触发重绘以启用动画
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            });
        
            // 3秒后移除
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    toast.remove();
                    // 若容器内无子元素则移除容器
                    if (container.children.length === 0) {
                        container.remove();
                    }
                }, 300); // 等动画结束
            }, duration);
        }

        document.getElementById('microbit').addEventListener('click',async()=>{
            showToast('开始烧录固件...')
        
            // 调用烧录方法
            console.log(window)
            const result = await window.electronAPI.flashFirmware()
            
            if (result.success) {
                showToast('固件烧录成功！', 'success')
            } else {
                showToast(`烧录失败: ${result.error}`, 'error')
            }
        })

        // 烧录按钮事件
        document.getElementById('common').addEventListener('click', () => {
            const port = document.getElementById('portSelector').value;
            if (!port || port === "请选择串口") {
                alert('请选择一个串口！');
                return;
            }
            electronAPI.sendWho({ who: 'common', port });
        });

        document.getElementById('xiaoZhi').addEventListener('click', () => {
            const port = document.getElementById('portSelector').value;
            if (!port || port === "请选择串口") {
                alert('请选择一个串口！');
                return;
            }
            electronAPI.sendWho({ who: 'xiaoZhi', port });
        });
        // document.getElementById('submit').addEventListener('click', async () => {
        //     const name = document.getElementById('name').value.trim();
        //     const password = document.getElementById('password').value.trim();
        //     if (!name || !password) {
        //         alert("请填写完整 Wi-Fi 信息！");
        //         return;
        //     }

        //     let info = await espSend.wifiInfo({ name, password });

        //     const qrContainer = document.getElementById('qrContainer');
        //     const img = document.getElementById('info');

        //     img.src = info;
        //     qrContainer.style.display = "block"; // 显示二维码
        // });
    </script>
</body>
</html>
