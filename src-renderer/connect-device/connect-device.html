<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline'"> -->
    <style>
      body {
        margin: 0;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        background-color: white;
        }

        .tab-bar {
            display: flex;
            padding-left: 20px;
            border-bottom: 2px solid #00bfa5;
            margin-bottom: 2px;
        }

            .tab {
            padding: 10px 25px 10px 20px;
            margin-right: 0px;
            background-color: white;
            color: #00bfa5;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid #00bfa5;
            border-bottom: none;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            transition: all 0.2s ease-in-out;
            position: relative;
            z-index: 0;
            /* clip-path: polygon(0 0, 85% 0, 100% 100%, 0 100%); */
            }

            .tab.active {
            background-color: #00bfa5;
            color: white;
            z-index: 1;
            }

        /* .tab::after {
        content: '';
        position: absolute;
        right: -1px;
        top: 0;
        width: 12px;
        height: 100%;
        background-color: inherit;
        border: 2px solid #00bfa5;
        border-left: none;
        border-top-right-radius: 12px;
        transform: skewX(-15deg);
        z-index: -1;
        } */



        .tab.active::after {
        background-color: #00bfa5;
        }

        .content {
        text-align: center;
        padding: 2px;
        }

        .content img {
        /* max-width: 75%; */
        }

        .warning {
        color: #ff9900;
        font-size: 16px;
        margin: 20px 0;
        }

        .help-button {
        background-color: #00bfa5;
        color: white;
        padding: 10px 25px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        }

        .tab-page {
        display: none;
        }

        .tab-page.active {
        display: block;
        }


        /* wifiè¿æ¥ */
        /* æ ‡é¢˜ */
        h1 {
          color: #ff4c4c;
          font-size: 22px;
          margin-bottom: 15px;
        }

        /* WiFi åˆ—è¡¨ */
        #wifi-list {
          height: 200px; /* è®¾å®šæœ€å¤§é«˜åº¦ */
          list-style: none;
          padding: 0;
          margin-bottom: 15px;
          background-color: #c2f3ec;
          overflow-y: auto;
          overflow-x: hidden; /* å¯é€‰ï¼Œé˜²æ­¢æ¨ªå‘æ»šåŠ¨æ¡ */
        }

        #qr-button {
          height: 200px; /* è®¾å®šæœ€å¤§é«˜åº¦ */
          list-style: none;
          padding: 0;
          margin-bottom: 15px;
          background-color: #c2f3ec;
          overflow-y: auto;
          overflow-x: hidden; /* å¯é€‰ï¼Œé˜²æ­¢æ¨ªå‘æ»šåŠ¨æ¡ */
          
        }

        /* #wifi-list li {
          background: transparent; 
          padding: 12px;
          margin: 8px auto;
          border-radius: 3px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
          cursor: pointer;
          transition: background 0.3s, transform 0.2s;
          border: 1px solid lch(51.35% 35.67 178.75);
          width: 80%; 
          
        } */
        

        /* #wifi-list li:hover {
          background: #9cf3e6;
        } */


        #wifi-list li {
          background: transparent;
          padding: 6px;
          margin: 8px auto;
          border-radius: 5px;
          width: 80%;
          /* max-width: 400px; */
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
          cursor: default;
          transition: background 0.3s, transform 0.2s;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border: 1px solid lch(51.35% 35.67 178.75);
        }

        #wifi-list li:hover {
          background: #9cf3e6;
          /* transform: scale(1.02); */
        }

        .connect-btn {
          /* padding: 6px 6px; */
          font-size: 14px;
          background-color: #00bfa5;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
        }

        .connect-btn.disconnect {
          background-color: #ff4c4c;
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
          display: inline-block;
          padding: 10px 15px;
          font-size: 16px;
          color: white;
          background-color: #00bfa5;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          transition: all 0.3s ease-in-out;
          margin-top: 10px;
        }

        button:hover {
          background-color: #3ee0b5;
          transform: scale(1.05);
        }

        /* è‡ªå®šä¹‰è¾“å…¥æ¡†ï¼ˆå¼¹çª—ï¼‰ */
        .input-dialog {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
          display: none;
          z-index: 1000;
          width: 250px;
          text-align: center;
        }

        .input-dialog input {
          width: 90%;
          padding: 8px;
          margin: 10px 0;
          border: 1px solid #ccc;
          border-radius: 5px;
          font-size: 14px;
        }

        .input-dialog input:focus {
          outline: none;
          border-color: #ff4c4c;
          box-shadow: 0 0 5px rgba(255, 76, 76, 0.5);
        }

        .input-dialog button {
          width: 100%;
          margin-top: 10px;
        }

        /* é®ç½©å±‚æ ·å¼ */
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5); /* åŠé€æ˜èƒŒæ™¯ */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        z-index: 2000;
        display: none; /* é»˜è®¤éšè— */
      }

      /* æ—‹è½¬åœ†ç¯ */
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
      }

      /* æ—‹è½¬åŠ¨ç”» */
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }



      /* äºŒç»´ç  */
        h2 {
            margin-bottom: 20px;
            color: #333;
        }

        input {
            width: 300px;
            padding: 10px;
            margin: 8px auto;
            border: 1px solid #41dd92;
            border-radius: 2px;
            font-size: 16px;
            background-color: transparent;
        }

        
        .qr-container {
            margin-top: 20px;
            display: none;
        }

        .qr-container img {
            width: 80%;
            height: 70%;
            border: 4px solid #ff4c4c;
            padding: 2px;
            background: white;
            border-radius: 8px;
        }

        .tab.disabled {
          color: gray;
          border-color: lightgray;
          background-color: #f4f4f4;
          cursor: not-allowed;
        }
        .tab.disabled:hover {
          background-color: #f4f4f4;
        }

        .password-wrapper {
            position: relative;
        }

        .password-wrapper input {
            /* padding-right: 40px;  */
        }

        .toggle-password {
            position: absolute;
            /* right: 10px; */
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 18px;
            color: #888;
            user-select: none;
        }
        /* #name{
          width: 60%;
        }
        #password{
          width: 60%;
        } */

    </style>
  </head>
  <body>

      <script>
        
        const {locale, strings} = connect.getTranslate();
        document.documentElement.lang = locale;

      </script>

      <div id="Container">


            <!-- Tab æ  -->
        <div class="tab-bar">
            <div class="tab" data-tab="serial">ä¸²å£</div>
            <div class="tab" data-tab="bluetooth">è“ç‰™</div>
            <div class="tab" data-tab="wifi">WIFI</div>
            <div class="tab" data-tab="qr">äºŒç»´ç </div>
        </div>

        <!-- å†…å®¹åŒº -->
        <div class="content">
            <div id="serial" class="tab-page">
                <!-- <p>è¯·é€‰æ‹©è¦è¿æ¥çš„è®¾å¤‡ç«¯å£ï¼š</p> -->
                <div id="bnContainer" class="button-container"></div>
            </div>
            <div id="bluetooth" class="tab-page">
                <button id="openBle">æ‰“å¼€è“ç‰™è¿æ¥ç•Œé¢</button>
            </div>
            <div id="wifi" class="tab-page">
                <!-- <img src="your-wifi-icon.png" alt="WiFi illustration" />
                <div class="warning">âš  æ²¡æœ‰å¯è¿æ¥çš„è®¾å¤‡</div>
                <button class="help-button" onclick="openHelp()">å¸®åŠ©</button> -->

                <!-- åŠ è½½é®ç½©å±‚ -->
                <div id="loading-overlay">
                  <div class="spinner"></div>
                  <p id="loadingImg">æ­£åœ¨è¿æ¥ Wi-Fi...</p>
                </div>

                <h1 id="currentWifi"></h1>
                <!-- <h1>å¯è¿æ¥wifi</h1> -->
                <ul id="wifi-list"></ul>
              
                <button id="disConnect">æ–­å¼€å½“å‰è¿æ¥</button>

                <!-- è‡ªå®šä¹‰å¯†ç è¾“å…¥æ¡† -->
                <div id="password-dialog" class="input-dialog">
                  <button id="submit-password">è¿æ¥</button>

                  <input id="wifi-name" placeholder="è¯·è¾“å…¥ä¿®æ”¹wifiå">
                  <button id="rename">æ”¹å</button>
                  <button id="cancel">å–æ¶ˆ</button>
                </div>


            </div>
            <div id="qr" class="tab-page">
              <div id="qr-button">
                 <h2 id="qrTitle">Wi-Fi äºŒç»´ç ç”Ÿæˆ</h2>
                <span id="account">è´¦å·</span>&nbsp;&nbsp;<input type="text" id="name">
                <div class="password-wrapper">
                    <span id="pwd">å¯†ç </span>&nbsp;&nbsp;<input type="password" id="password">
                    <span id="togglePassword" class="toggle-password">ğŸ™ˆ</span>
                </div>
                

              </div>
              <button id="submit">ç”ŸæˆäºŒç»´ç </button>
              <!-- <button id="submit-usb-card">å¼€å¯çƒ­ç‚¹å¹¶ç”ŸæˆäºŒç»´ç </button> -->
              <!-- <button id="submitonly">ä»…ç”ŸæˆäºŒç»´ç </button> -->
             
              <div class="qr-container" id="qrContainer">
                  <p id="pleaseScanQr">è¯·æ‰«æäºŒç»´ç è¿æ¥ Wi-Fi(ç¡®ä¿ç”µè„‘çƒ­ç‚¹å¼€å¯)</p>
                  <img id="info" src="" alt="Wi-Fi äºŒç»´ç ">
              </div>
            </div>
            <div id="default-page" class="tab-page">
              <h1>è¯·å…ˆé€‰æ‹©è®¾å¤‡</h1>
              <p style="color: gray;">å½“å‰æ²¡æœ‰å¯ç”¨çš„è¿æ¥æ–¹å¼</p>
            </div>
        </div>

        
      </div>
      <script>

        //ç¿»è¯‘
        document.querySelector('.tab[data-tab="serial"]').textContent = strings['connect-device.serial'];
        document.querySelector('.tab[data-tab="bluetooth"]').textContent = strings['connect-device.bluetooth'];
        document.querySelector('.tab[data-tab="qr"]').textContent = strings['connect-device.qr'];

        document.getElementById('disConnect').textContent=strings['connect-device.disconnectAll'];

        document.getElementById('account').textContent=strings['connect-device.account'];
        document.getElementById('pwd').textContent=strings['connect-device.pwd'];
        document.getElementById('qrTitle').textContent=strings['connect-device.qrTitle'];
        document.getElementById('submit').textContent=strings['connect-device.submit'];

        document.getElementById('loadingImg').textContent=strings['connect-device.loadingImg'];

        document.getElementById('openBle').textContent=strings['connect-device.openBle'];

        document.getElementById('pleaseScanQr').textContent=strings['please-scan-qr'];
        
          let portStatusMap = {}; // å…¨å±€å­˜å‚¨ç«¯å£çŠ¶æ€
          let currentConnectedPort = null; // å½“å‰è¿æ¥çš„ç«¯å£
          const tabs = document.querySelectorAll('.tab');
          const pages = document.querySelectorAll('.tab-page');
          const extension = window.connect.getExtensions()

          console.log(extension)
          // æ§åˆ¶å“ªäº› tab å¯ç‚¹å‡»ï¼ˆtrue = å¯ç‚¹å‡»ï¼Œfalse = ç°ç½®ï¼‰
          let tabEnabledMap = {
            serial: false,
            bluetooth: false,
            wifi: false,
            qr: false
          };

          if(extension.wifi==1){
            // tabEnabledMap.serial=true
            tabEnabledMap.bluetooth=true

          }else if(extension.wifi==2){
            tabEnabledMap.wifi=true
            tabEnabledMap.qr=true
            // tabEnabledMap.serial=true
          }else if(extension.wifi==3){
            tabEnabledMap.serial=true
          }
          let wifiIntervalId = null;
          let offlineHandler = null;

          // tabs.forEach(tab => {
          //   tab.addEventListener('click', () => {
          //     const selected = tab.dataset.tab;

          //     tabs.forEach(t => t.classList.remove('active'));
          //     pages.forEach(p => p.classList.remove('active'));

          //     tab.classList.add('active');
          //     document.getElementById(selected).classList.add('active');

          //     if (selected === 'wifi') {
          //       wifiInit();
          //     } else {
          //       wifiCleanup();
          //       // å¯åœ¨æ­¤å¤„æ·»åŠ  serial æˆ– bluetooth çš„åˆå§‹åŒ–æ¥å£
          //       if(selected === 'qr'){
          //         qrInit()
          //       }else if(selected === 'bluetooth'){
          //         bleInit()
          //       }
          //     }
          //   });
          // });


          let hasEnabledTab = false;

          tabs.forEach(tab => {
              const tabName = tab.dataset.tab;

              // è®¾ç½®ç¦ç”¨æ ·å¼
              if (!tabEnabledMap[tabName]) {
                tab.classList.add('disabled');
              }


              if (tabEnabledMap[tabName]) {
                if (!hasEnabledTab) {
                  // é»˜è®¤æ¿€æ´»ç¬¬ä¸€ä¸ªå¯ç”¨ tab
                  tab.classList.add('active');
                  document.getElementById(tabName).classList.add('active');

                  const selected = tab.dataset.tab;
                  if (selected === 'wifi') {
                    wifiInit();
                    removeQr()
                  } else {
                    wifiCleanup();
                    if(selected === 'qr'){
                      qrInit();
                    } else if(selected === 'bluetooth'){
                      bleInit();
                    }else if(selected === 'serial'){
                      serialInit()
                      startPortMonitoring()
                       setInterval(() => {
                          serialInit();
                      }, 2000); // æ¯ 5 ç§’åˆ·æ–°ä¸€æ¬¡ä¸²å£åˆ—è¡¨
                    }
                  }
                }
                hasEnabledTab = true;
              }

              tab.addEventListener('click', () => {
                // è‹¥å½“å‰ tab ä¸å¯ç‚¹å‡»ï¼Œåˆ™å¿½ç•¥
                if (!tabEnabledMap[tabName]) return;

                const selected = tab.dataset.tab;

                tabs.forEach(t => t.classList.remove('active'));
                pages.forEach(p => p.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(selected).classList.add('active');

                if (selected === 'wifi') {
                  wifiInit();
                } else {
                  wifiCleanup();
                  if(selected === 'qr'){
                    qrInit();
                  } else if(selected === 'bluetooth'){
                    bleInit();
                  }else if(selected === 'serial'){
                    serialInit()
                    startPortMonitoring()
                    setInterval(() => {
                        serialInit();
                    }, 2000); // æ¯ 5 ç§’åˆ·æ–°ä¸€æ¬¡ä¸²å£åˆ—è¡¨
                  }
                }
              });
          });

           if (!hasEnabledTab) {
            // æ‰€æœ‰æ ‡ç­¾éƒ½ç¦ç”¨ï¼Œæ˜¾ç¤ºé»˜è®¤é¡µ
            document.getElementById('default-page').classList.add('active');
          }

          function showToast(message, duration = 3000) {
              // å¦‚æœ toast å®¹å™¨ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª
              let container = document.getElementById('toast-container');
              if (!container) {
                  container = document.createElement('div');
                  container.id = 'toast-container';
                  Object.assign(container.style, {
                      position: 'fixed',
                      top: '20px',
                      right: '20px',
                      zIndex: '9999',
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '10px'
                  });
                  document.body.appendChild(container);
              }
          
              // åˆ›å»º toast å…ƒç´ 
              const toast = document.createElement('div');
              if(message == 'è¯·å¡«å†™å®Œæ•´ Wi-Fi ä¿¡æ¯ï¼'){
                toast.textContent=strings['connect-device.showToast.wifiinfo']
              }else if(message == 'çƒ­ç‚¹åç§°è‡³å°‘8ä½ï¼'){
                toast.textContent=strings['connect-device.showToast.wifiNameLen']
              }else if(message == 'ç‚¹å‡»å›¾ç‰‡æˆ–æŒ‰ESCé”®é€€å‡ºå…¨å±'){
                toast.textContent=strings['connect-device.showToast.escFullScreen']
              }else if(message == 'è¿æ¥æˆåŠŸ'){
                toast.textContent=strings['connect-device.showToast.connectSuccess']
              }else if(message == 'è¿æ¥è¶…æ—¶ï¼Œè¯·é‡è¯•'){
                toast.textContent=strings['connect-device.showToast.connectTimeout']
              }else if(message == 'å·²æ–­å¼€'){
                toast.textContent=strings['connect-device.showToast.disConnect']
              }else if(message =='æ–­å¼€å¤±è´¥'){
                toast.textContent=strings['connect-device.showToast.disconnectFailed']
              }
              // toast.textContent = message;
          
              // æ ·å¼è®¾ç½®
              Object.assign(toast.style, {
                  background: '#333',
                  color: '#fff',
                  padding: '10px 20px',
                  borderRadius: '8px',
                  boxShadow: '0 2px 8px rgba(0,0,0,0.2)',
                  opacity: '0',
                  transform: 'translateY(-20px)',
                  transition: 'opacity 0.3s ease, transform 0.3s ease',
                  maxWidth: '300px'
              });
          
              // æ·»åŠ  toast åˆ°å®¹å™¨
              container.appendChild(toast);
          
              // å¼ºåˆ¶è§¦å‘é‡ç»˜ä»¥å¯ç”¨åŠ¨ç”»
              requestAnimationFrame(() => {
                  toast.style.opacity = '1';
                  toast.style.transform = 'translateY(0)';
              });
          
              // 3ç§’åç§»é™¤
              setTimeout(() => {
                  toast.style.opacity = '0';
                  toast.style.transform = 'translateY(-20px)';
                  setTimeout(() => {
                      toast.remove();
                      // è‹¥å®¹å™¨å†…æ— å­å…ƒç´ åˆ™ç§»é™¤å®¹å™¨
                      if (container.children.length === 0) {
                          container.remove();
                      }
                  }, 300); // ç­‰åŠ¨ç”»ç»“æŸ
              }, duration);
          }

          function wifiInit() {
            console.log('[WiFi] åˆå§‹åŒ–');

            // ç¦»çº¿ç›‘å¬
            offlineHandler = () => {
              console.log('ç½‘ç»œæ–­å¼€');
            };
            window.addEventListener('offline', offlineHandler);

            // åŠ è½½ WiFi åˆ—è¡¨
            async function loadWifiList() {
              // console.log(window.connect.currentWifi());
              // document.getElementById('currentWifi').innerText = window.connect.currentWifi().wifi;

              // try {
              //   const networks = await window.connect.scanWifi();
              //   const wifiListElement = document.getElementById('wifi-list');
              //   wifiListElement.innerHTML = '';

              //   networks.forEach((network, index) => {
              //     // if (network.ssid.startsWith('ICR')) {
              //       const li = document.createElement('li');
              //       li.textContent = network.ssid;
              //       li.addEventListener('click', () => connectToWifi(network.ssid));
              //       wifiListElement.appendChild(li);
              //     // }
              //   });
              // } catch (error) {
              //   console.error('Error scanning Wi-Fi networks:', error);
              // }


              const current = await window.connect.currentWifi();
              const currentSSID = current?.wifi || '';


              try {
                const networks = await window.connect.scanWifi();
                const wifiListElement = document.getElementById('wifi-list');
                wifiListElement.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨

                networks.forEach((network) => {
                  if (network.ssid.startsWith('ICR')) {
                    const li = document.createElement('li');

                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = network.ssid;

                    const btn = document.createElement('button');
                    btn.classList.add('connect-btn');

                    if (network.ssid === currentSSID) {
                      // btn.textContent = 'æ–­å¼€';
                      btn.textContent=strings['connect-device.disconnect']
                      btn.classList.add('disconnect');
                      btn.onclick = async () => {
                        await window.connect.disConn();
                        await loadWifiList(); // æ–­å¼€ååˆ·æ–°åˆ—è¡¨
                      };
                    } else {
                      // btn.textContent = 'è¿æ¥';
                      btn.textContent=strings['connect-device.connectwifi']
                      btn.onclick = async () => {
                        document.getElementById('loading-overlay').style.display = 'flex';

                        try {
                          console.log(network.ssid)
                          await window.connect.connectWifi(network.ssid, 'lgm010611');
                          // alert(`æˆåŠŸè¿æ¥ ${network.ssid}`);
                          await window.connect.isClose(true);
                        } catch (error) {
                          alert(`è¿æ¥å¤±è´¥ ${network.ssid}: ${error.message}`);
                        } finally {
                          document.getElementById('loading-overlay').style.display = 'none';
                          await loadWifiList(); // æˆåŠŸæˆ–å¤±è´¥éƒ½åˆ·æ–°
                        }
                      };
                    }

                    li.appendChild(nameSpan);
                    li.appendChild(btn);
                    wifiListElement.appendChild(li);
                  }
                });
              } catch (error) {
                console.error('Error scanning Wi-Fi networks:', error);
              }
            }

            wifiIntervalId = setInterval(loadWifiList, 1000);
            loadWifiList();

            const disConnect = document.getElementById('disConnect');
            disConnect.onclick = async () => {
              console.log('æ–­å¼€ WiFi');
              await window.connect.disConn();
            };

            async function connectToWifi(ssid) {
              const passwordDialog = document.getElementById('password-dialog');
              const submitButton = document.getElementById('submit-password');
              const nameInput = document.getElementById('wifi-name');
              const rename = document.getElementById('rename');
              const cancel = document.getElementById('cancel');
              passwordDialog.style.display = 'block';
              nameInput.value = '';

              function containsChinese(text) {
                return /[\u4e00-\u9fa5]/.test(text);
              }

              const response = await window.connect.sendData('whatssid');
              console.log('[WiFi] å½“å‰SSIDå“åº”', response);

              if (ssid === response) {
                submitButton.style.display = 'none';
                nameInput.style.display = 'block';
                rename.style.display = 'block';

                rename.onclick = async () => {
                  if (!nameInput.value) {
                    alert('è¯·è¾“å…¥ä¿®æ”¹åçš„åå­—');
                    return;
                  } else if (containsChinese(nameInput.value)) {
                    alert('è¯·å‹¿è¾“å…¥ä¸­æ–‡');
                    return;
                  }

                  const renameResult = await window.connect.changeName('ICRobot_' + nameInput.value);
                  if (renameResult) {
                    alert('æ”¹åæˆåŠŸï¼Œå¦‚éœ€ä½¿ç”¨æ–°åç§°è¯·é‡å¯è®¾å¤‡');
                    passwordDialog.style.display = 'none';
                  }
                };
              } else {
                submitButton.style.display = 'block';
                nameInput.style.display = 'none';
                rename.style.display = 'none';

                submitButton.onclick = async () => {
                  const password = '123';
                  document.getElementById('loading-overlay').style.display = 'flex';

                  try {
                    const result = await window.connect.connectWifi(ssid, password);
                    alert(`æˆåŠŸè¿æ¥ ${ssid}`);
                    passwordDialog.style.display = 'none';
                    document.getElementById('loading-overlay').style.display = 'none';
                    await window.connect.isClose(true);
                  } catch (error) {
                    passwordDialog.style.display = 'none';
                    document.getElementById('loading-overlay').style.display = 'none';
                    alert(`è¿æ¥å¤±è´¥ ${ssid}: ${error.message}`);
                  }
                };
              }

              cancel.onclick = () => {
                passwordDialog.style.display = 'none';
              };
            }
          }

          function wifiCleanup() {
            console.log('[WiFi] æ¸…ç†å®šæ—¶å™¨ä¸ç›‘å¬å™¨');

            if (wifiIntervalId !== null) {
              clearInterval(wifiIntervalId);
              wifiIntervalId = null;
            }

            if (offlineHandler) {
              window.removeEventListener('offline', offlineHandler);
              offlineHandler = null;
            }

            // å¯æ¸…ç†å…¶ä»–WiFiç›¸å…³çŠ¶æ€ï¼Œä¾‹å¦‚loadingæˆ–å¼¹çª—
            document.getElementById('password-dialog').style.display = 'none';
            document.getElementById('loading-overlay').style.display = 'none';
          }

          // å¯é€‰ï¼šåˆå§‹é»˜è®¤æ¿€æ´» WiFi
          wifiInit();

          // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨å‡½æ•°
          function scrollToBottom() {
              window.scrollTo({
                  top: document.body.scrollHeight,
                  behavior: 'smooth'
              });
          }


           function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            this.textContent = isPassword ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
          }
          async function hostPotWire(){
             const name = document.getElementById('name').value.trim();
            const password = document.getElementById('password').value.trim();
            if (!name || !password) {
                // alert("è¯·å¡«å†™å®Œæ•´ Wi-Fi ä¿¡æ¯ï¼");
                showToast('è¯·å¡«å†™å®Œæ•´ Wi-Fi ä¿¡æ¯ï¼')
                return;
            }

            if(name.length<8){
                showToast('çƒ­ç‚¹åç§°è‡³å°‘8ä½ï¼')
                return;
            }
            await window.connect.setHistory({ name, password })
          

            let isConnect=true
            let info = await window.connect.usbWifiInfo({ name, password,isConnect });

            const qrContainer = document.getElementById('qrContainer');
            const img = document.getElementById('info');

            img.src = info;
            qrContainer.style.display = "block"; // æ˜¾ç¤ºäºŒç»´ç 
            scrollToBottom()
          }

          function removeQr(){
            document.getElementById('togglePassword').removeEventListener('click',togglePasswordVisibility)
            // document.getElementById('submit-usb-card').removeEventListener('click',hostPotWire)
          }

          function qrInit(){
              document.getElementById('name').value=window.connect.getHistory().name
              document.getElementById('password').value=window.connect.getHistory().pass

              document.getElementById('togglePassword').addEventListener('click', togglePasswordVisibility);
              document.getElementById('submit').addEventListener('click', async () => {
                  const name = document.getElementById('name').value.trim();
                  const password = document.getElementById('password').value.trim();
                  console.log(name)
                  console.log(password);
                  
                  if (!name || !password) {
                      // alert("è¯·å¡«å†™å®Œæ•´ Wi-Fi ä¿¡æ¯ï¼");
                      showToast('è¯·å¡«å†™å®Œæ•´ Wi-Fi ä¿¡æ¯ï¼')
                      return;
                  }
                  await window.connect.setHistory({ name, password })
                

                  let isConnect=true
                  let info = await window.connect.wifiInfo({ name, password,isConnect });

                  const qrContainer = document.getElementById('qrContainer');
                  const img = document.getElementById('info');

                   // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ
                  img.onload = function() {
                    scrollToBottom(); // ç¡®ä¿å›¾ç‰‡åŠ è½½åæ»šåŠ¨
                  };
                  img.src = info;
                  qrContainer.style.display = "block"; // æ˜¾ç¤ºäºŒç»´ç 
                  // scrollToBottom()
              });


              // document.getElementById('submitonly').addEventListener('click',async()=>{
              //   const name = document.getElementById('name').value.trim();
              //     const password = document.getElementById('password').value.trim();
              //     console.log(name)
              //     console.log(password);
                  
              //     if (!name || !password) {
              //         // alert("è¯·å¡«å†™å®Œæ•´ Wi-Fi ä¿¡æ¯ï¼");
              //         showToast('è¯·å¡«å†™å®Œæ•´ Wi-Fi ä¿¡æ¯ï¼')
              //         return;
              //     }
              //     await window.connect.setHistory({ name, password })
                

              //     let isConnect=false
              //     let info = await window.connect.wifiInfo({ name, password,isConnect });

              //     const qrContainer = document.getElementById('qrContainer');
              //     const img = document.getElementById('info');

              //     img.src = info;
              //     qrContainer.style.display = "block"; // æ˜¾ç¤ºäºŒç»´ç 
              //     scrollToBottom()
              // })

              // document.getElementById("info").onclick =async function () {
              //   if(!document.fullscreenElement){
              //     showToast('ç‚¹å‡»å›¾ç‰‡æˆ–æŒ‰ESCé”®é€€å‡ºå…¨å±')
              //     await new Promise(resolve => setTimeout(resolve, 1000));
              //     if (this.requestFullscreen) {
              //       this.requestFullscreen(); // è¿›å…¥å…¨å±
              //     } else if (this.webkitRequestFullscreen) {
              //       this.webkitRequestFullscreen(); // Safari
              //     } else if (this.msRequestFullscreen) {
              //       this.msRequestFullscreen(); // IE11
              //     }
              //   }else{
              //     document.exitFullscreen();
              //   }
                
              // };

              // document.getElementById("info").ondblclick = function () {
              //   if (document.fullscreenElement) {
              //     document.exitFullscreen();
              //   }
              // }
              document.getElementById('submit-usb-card').addEventListener('click', hostPotWire);
          }

          function bleInit(){
            document.getElementById('openBle').addEventListener('click',()=>{
              window.connect.openBle(true)
            })
          }

          // function serialInit(){
          //     const ports = connect.getPorts();
          //     let portsArr = ports.PORTS;
          //     document.getElementById('bnContainer').innerHTML=''

          //     for (let i = 0; i < portsArr.length; i++) {
          //         let button = document.createElement('button');
          //         button.innerText = `è¿æ¥ ${portsArr[i]}`;
          //         button.id = 'bn' + i;
          //         button.style.backgroundColor='transparent'
          //         button.style.border='1px solid #41dd92'
          //         button.style.color = '#000'; 
          //         button.style.width='70%'
          //         button.addEventListener('click', () => {
          //             connect.sendConnectPort(portsArr[i]);
          //             setTimeout(() => {
          //                 const flag = connect.isConnected();
          //                 if (flag.flag) {
          //                     alert('âœ… è¿æ¥æˆåŠŸï¼');
          //                 } else {
          //                     alert('âŒ è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
          //                 }
          //             }, 800);
          //         });
          //         document.getElementById('bnContainer').appendChild(button);
          //     }
          // }

          

          // function serialInit() {
          //     const ports = connect.getPorts();
          //     const portsArr = ports.PORTS;
          //     const bnContainer = document.getElementById('bnContainer');
          //     bnContainer.innerHTML = ''; 
              
          //     // è·å–å½“å‰è¿æ¥çŠ¶æ€
          //     const statusResponse = connect.whatPortConnect();
          //     currentConnectedPort = statusResponse.port || null;
              
          //     portsArr.forEach(port => {
          //         const isConnected = port === currentConnectedPort;
          //         portStatusMap[port] = isConnected; // æ›´æ–°çŠ¶æ€æ˜ å°„
                  
          //         bnContainer.style.height='300px'
          //         bnContainer.style.backgroundColor='#c2f3ec'
          //         // åˆ›å»ºUIå…ƒç´ 
          //         const buttonContainer = document.createElement('div');
          //         // buttonContainer.style.display = 'flex';
          //         // buttonContainer.style.alignItems = 'center';
          //         // buttonContainer.style.marginBottom = '10px';

          //         buttonContainer.style.display = 'flex';
          //         buttonContainer.style.justifyContent = 'center'; // æ°´å¹³å±…ä¸­[6,7](@ref)
          //         buttonContainer.style.alignItems = 'center';      // å‚ç›´å±…ä¸­[6,7](@ref)
          //         buttonContainer.style.margin = '0 auto 10px';     // ä¸Šä¸‹è¾¹è·+æ°´å¹³å±…ä¸­[8](@ref)
          //         buttonContainer.style.width = '80%';
          //         buttonContainer.style.backgroundColor = 'transparent'; // èƒŒæ™¯é€æ˜[3,9](@ref)
          //         buttonContainer.style.border = '1px solid #00ff00';    // ç»¿è‰²è¾¹æ¡†[4,9](@ref)
          //         buttonContainer.style.borderRadius = '4px';            // åœ†è§’è¾¹æ¡†
          //         buttonContainer.style.padding = '8px';                 // å†…è¾¹è·
          //         buttonContainer.id = `port-${port}`; // å”¯ä¸€IDä¾¿äºåç»­æ›´æ–°
                  
          //         const portLabel = document.createElement('span');
          //         portLabel.textContent = port;
          //         portLabel.style.flex = '1';
          //         portLabel.style.textAlign = 'left';
          //         portLabel.style.marginRight = '10px';
                  
          //         const actionButton = document.createElement('button');
          //         updateButtonState(actionButton, isConnected); // ç»Ÿä¸€æ›´æ–°æŒ‰é’®çŠ¶æ€
                  
          //         // ç‚¹å‡»äº‹ä»¶å¤„ç†
          //         actionButton.addEventListener('click', async () => {
          //             if (portStatusMap[port]) {
          //                 await handleDisconnect(port);
          //             } else {
          //                 await handleConnect(port);
          //             }
          //             updatePortUI(port); // æ›´æ–°å•ä¸ªç«¯å£çš„UI
          //         });
                  
          //         buttonContainer.appendChild(portLabel);
          //         buttonContainer.appendChild(actionButton);
          //         bnContainer.appendChild(buttonContainer);
          //     });

          //     startPortMonitoring();
          // }

          // // æ›´æ–°æŒ‰é’®çŠ¶æ€
          // function updateButtonState(button, isConnected) {
          //     button.innerText = isConnected ? 'æ–­å¼€' : 'è¿æ¥';
          //     button.style.backgroundColor = isConnected ? '#ff4c4c' : '#00bfa5';
          //     button.style.color = 'white';
          //     button.style.border = 'none';
          //     button.style.borderRadius = '4px';
          //     button.style.padding = '5px 10px';
          //     button.style.cursor = 'pointer';
          // }

          // // å¤„ç†è¿æ¥
          // async function handleConnect(port) {
          //     connect.sendConnectPort(port);
          //     const button = document.querySelector(`#port-${port} button`);
          //     button.innerText = 'è¿æ¥ä¸­...';
          //     button.style.backgroundColor = '#ff9900';
              
          //     // æ·»åŠ è¿æ¥çŠ¶æ€æ£€æµ‹
          //     const checkInterval = setInterval(() => {
          //         const status = connect.whatPortConnect();
          //         if (status.port === port) {
          //             portStatusMap[port] = true;
          //             currentConnectedPort = port;
          //             clearInterval(checkInterval);
          //             updatePortUI(port);
          //             showToast(`âœ… ${port} è¿æ¥æˆåŠŸ`);
          //         }
          //     }, 300);
          // }

          // // å¤„ç†æ–­å¼€
          // async function handleDisconnect(port) {
          //     connect.disconnectPort();
          //     portStatusMap[port] = false;
          //     if (currentConnectedPort === port) currentConnectedPort = null;
          //     showToast(`å·²æ–­å¼€ ${port}`);
          // }

          // // æ›´æ–°å•ä¸ªç«¯å£çš„UI
          // function updatePortUI(port) {
          //     const container = document.getElementById(`port-${port}`);
          //     if (!container) return;
              
          //     const button = container.querySelector('button');
          //     updateButtonState(button, portStatusMap[port]);
          // }

          // // å®šæœŸæ£€æŸ¥æ‰€æœ‰ç«¯å£çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
          // function startPortMonitoring() {
          //     setInterval(() => {
          //         const status = connect.whatPortConnect();
          //         if (status.port !== currentConnectedPort) {
          //             // è¿æ¥çŠ¶æ€å˜åŒ–æ—¶æ›´æ–°æ‰€æœ‰UI
          //             Object.keys(portStatusMap).forEach(port => {
          //                 portStatusMap[port] = (port === status.port);
          //                 updatePortUI(port);
          //             });
          //             currentConnectedPort = status.port;
          //         }
          //     }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
          // }


          function serialInit() {
            
            const ports = connect.getPorts();
            const portsArr = ports.PORTS;
            console.log(portsArr)
            const bnContainer = document.getElementById('bnContainer');
            bnContainer.innerHTML = '';
            portStatusMap = {}; // âœ… æ¸…ç©ºæ—§çŠ¶æ€

            // è·å–å½“å‰è¿æ¥çŠ¶æ€
            const statusResponse = connect.whatPortConnect();
            currentConnectedPort = statusResponse.port || null;

            portsArr.forEach(port => {
                const isConnected = port.path === currentConnectedPort;
                portStatusMap[port.path] = isConnected;

                bnContainer.style.height = '280px';
                bnContainer.style.backgroundColor = '#c2f3ec';
                bnContainer.style.overflowY = 'auto';

                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'flex';
                buttonContainer.style.justifyContent = 'center';
                buttonContainer.style.alignItems = 'center';
                buttonContainer.style.margin = '0 auto 10px';
                buttonContainer.style.width = '80%';
                buttonContainer.style.backgroundColor = 'transparent';
                buttonContainer.style.border = '1px solid #00ff00';
                buttonContainer.style.borderRadius = '4px';
                buttonContainer.style.padding = '8px';
                buttonContainer.id = `port-${port.path}`;

                const portLabel = document.createElement('span');
                portLabel.textContent = port.label;
                portLabel.style.flex = '1';
                portLabel.style.textAlign = 'left';
                portLabel.style.marginRight = '10px';

                const actionButton = document.createElement('button');
                updateButtonState(actionButton, isConnected);

                actionButton.addEventListener('click', async () => {
                    // å¦‚æœå·²è¿æ¥å…¶ä»–ä¸²å£ï¼Œå…ˆæ–­å¼€å®ƒ
                    if (currentConnectedPort && currentConnectedPort !== port.path) {
                        await handleDisconnect(currentConnectedPort);
                    }

                    // await new Promise(resolve => setTimeout(resolve, 1000));

                    if (portStatusMap[port.path]) {
                        await handleDisconnect(port.path);
                    } else {
                        await handleConnect(port.path);
                    }
                });

                buttonContainer.appendChild(portLabel);
                buttonContainer.appendChild(actionButton);
                bnContainer.appendChild(buttonContainer);
            });

            // startPortMonitoring();
        }

        function updateButtonState(button, isConnected) {
            // button.innerText = isConnected ? 'æ–­å¼€' : 'è¿æ¥';
            button.innerText = isConnected ? strings['connect-device.disconnect'] : strings['connect-device.connectwifi'];
            
            button.style.backgroundColor = isConnected ? '#ff4c4c' : '#00bfa5';
            button.style.color = 'white';
            button.style.border = 'none';
            button.style.borderRadius = '4px';
            button.style.padding = '5px 10px';
            button.style.cursor = 'pointer';
        }

        async function handleConnect(port) {
            const button = document.querySelector(`#port-${port} button`);
            button.disabled = true;
            // button.innerText = 'è¿æ¥ä¸­...';
            button.innerText =strings['connect-device.connecting']
            button.style.backgroundColor = '#ff9900';

            connect.sendConnectPort(port);

            const checkInterval = setInterval(() => {
                const status = connect.whatPortConnect();
                console.log(status.port)
                if (status.port === port) {
                    clearInterval(checkInterval);
                    portStatusMap = {}; // é‡ç½®æ‰€æœ‰çŠ¶æ€
                    portStatusMap[port] = true;
                    currentConnectedPort = port;

                    clearTimeout(timeout)
                    updateAllPortUI();
                    showToast(`è¿æ¥æˆåŠŸ`);
                }
            }, 300);

            // è®¾ç½®æœ€å¤§è¶…æ—¶æ—¶é—´ï¼ˆé˜²æ­¢æ­»å¾ªç¯ï¼‰
            let timeout=setTimeout(() => {
                clearInterval(checkInterval);

                // è¶…æ—¶æœªè¿æ¥æˆåŠŸï¼Œå›é€€æŒ‰é’®çŠ¶æ€
                if (currentConnectedPort !== port) {
                    portStatusMap[port] = false;
                    updateAllPortUI();
                    showToast(`è¿æ¥è¶…æ—¶ï¼Œè¯·é‡è¯•`);
                }
            }, 5000);

        }

        async function handleDisconnect(port) {
            let result = await connect.disconnectPort();
            if(result.success){
              portStatusMap[port] = false;
              if (currentConnectedPort === port) currentConnectedPort = null;

              updateAllPortUI();
              showToast(`å·²æ–­å¼€`);
            }else{
              showToast(`æ–­å¼€å¤±è´¥`);
            }
            
        }

        function updatePortUI(port) {
            const container = document.getElementById(`port-${port}`);
            if (!container) return;
            const button = container.querySelector('button');
            updateButtonState(button, portStatusMap[port]);
            button.disabled = false;
        }

        function updateAllPortUI() {
            Object.keys(portStatusMap).forEach(port => {
                updatePortUI(port);
            });
        }

        function startPortMonitoring() {
            setInterval(() => {
                const status = connect.whatPortConnect();
                if (status.port !== currentConnectedPort) {
                    Object.keys(portStatusMap).forEach(port => {
                        portStatusMap[port] = (port === status.port);
                    });
                    currentConnectedPort = status.port;
                    updateAllPortUI();
                }
            }, 2000);
        }

       



        
      </script>

    <!-- </main> -->
  </body>
</html>
